<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Interativo - Nova Friburgo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #mapa {
      height: 100vh;
      width: 100%;
    }
    .search-box {
      position: absolute;
      top: 200px;
      left: 25px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="search-box">
    <label><input type="checkbox" id="checkCamera" checked> Câmeras ao vivo</label><br>
    <label><input type="checkbox" id="checkApoio" checked> Pontos de apoio</label><br>
    <label for="raioBusca">Raio (km):</label>
    <input type="number" id="raioBusca" value="2" min="1" max="50" /><br>
    <button onclick="buscarProximos()">Buscar</button>
  </div>

  <div id="mapa"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const mapa = L.map("mapa").setView([-22.285, -42.531], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
    }).addTo(mapa);

    const apiKey = "1406a60c8d59eca8d3b007e2e83df790";

    const nuvens = L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${apiKey}`);
    const chuva = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${apiKey}`);
    const vento = L.tileLayer(`https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${apiKey}`);

    const camadas = {
      "Nuvens": nuvens,
      "Chuva": chuva,
      "Vento": vento,
    };

    L.control.layers(null, camadas).addTo(mapa);

    const iconeCamera = L.icon({
      iconUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQiAN64dFWlAbes6GL9FXhIYCoot9F7S8LXmAoh8x0SORG28ZMrp396RDK4pfbDth0eq7Q&usqp=CAU",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const iconeApoio = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const cameras = [
      {
        nome: "Av. Rui Barbosa",
        coord: [-22.270881, -42.533057],
        iframe: `<iframe
                  src="https://player.twitch.tv/?channel=rbmseg2pedras&parent=nfci.pmnf.rj.gov.br"
                  height="<height>"
                  width="<width>"
                  allowfullscreen>
                 </iframe>`
      },
      {
        nome: "Duas Pedras - Av. Gov. Roberto Silveira",
        coord: [-22.258614, -42.530943],
        iframe: `<iframe src="https://player.twitch.tv/?channel=rbmseg2pedras&parent=nfci.pmnf.rj.gov.br" allowfullscreen width="400" height="350" frameborder="0"></iframe>`
      },
      {
        nome: "Centro - Paissandu - Av. Comte. Bittencourt",
        coord: [-22.286717, -42.533602],
        iframe: `<iframe src="https://player.twitch.tv/?channel=rbmseg_paissandu&parent=nfci.pmnf.rj.gov.br" allowfullscreen width="400" height="350" frameborder="0"></iframe>`
      },
      {
        nome: "Centro - Av. Euterpe Friburguense",
        coord: [-22.277544, -42.533753],
        iframe: `<iframe src="https://player.twitch.tv/?channel=rbmseg_euterpe&parent=nfci.pmnf.rj.gov.br" allowfullscreen width="400" height="350" frameborder="0"></iframe>`
      },
      {
        nome: "Teste - Groove IP",
        coord: [-22.2880378, -42.5318424],
        iframe: `<iframe src="https://www.nethorizontes.com.br/flashmediaserver/grooveip01" allowfullscreen width="320" height="350" frameborder="0"></iframe>`
      }
    ];

    const pontosApoio = [
      { nome: "Cmei Elza Barbosa Melhorança", coord: [-22.3075440, -42.5350240] },
      { nome: "Escola Municipal Umbelina Breder De Queiroz", coord: [-22.2389290, -42.5356370] },
    ];

    const grupoCameras = L.layerGroup();
    const grupoApoio = L.layerGroup();

    function calcularDistancia(origem, destino) {
      const R = 6371;
      const lat1 = origem[0] * Math.PI / 180;
      const lat2 = destino[0] * Math.PI / 180;
      const deltaLat = (destino[0] - origem[0]) * Math.PI / 180;
      const deltaLon = (destino[1] - origem[1]) * Math.PI / 180;

      const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    cameras.forEach(item => {
      const marcador = L.marker(item.coord, { icon: iconeCamera })
        .bindPopup(`<strong>${item.nome}</strong><br>${item.iframe}`);
      grupoCameras.addLayer(marcador);
    });
    grupoCameras.addTo(mapa);

    pontosApoio.forEach(item => {
      const marcador = L.marker(item.coord, { icon: iconeApoio })
        .bindPopup(`<strong>${item.nome}</strong><br><a href="https://www.google.com/maps/dir/?api=1&destination=${item.coord[0]},${item.coord[1]}" target="_blank">Ver rota</a>`);
      grupoApoio.addLayer(marcador);
    });
    grupoApoio.addTo(mapa);

    function buscarProximos() {
      const raio = parseFloat(document.getElementById("raioBusca").value);
      const userLoc = mapa.getCenter();
      const origem = [userLoc.lat, userLoc.lng];

      grupoCameras.clearLayers();
      grupoApoio.clearLayers();

      if (document.getElementById("checkCamera").checked) {
        cameras.forEach(item => {
          if (calcularDistancia(origem, item.coord) <= raio) {
            const marcador = L.marker(item.coord, { icon: iconeCamera })
              .bindPopup(`<strong>${item.nome}</strong><br>${item.iframe}`);
            grupoCameras.addLayer(marcador);
          }
        });
      }

      if (document.getElementById("checkApoio").checked) {
        pontosApoio.forEach(item => {
          if (calcularDistancia(origem, item.coord) <= raio) {
            const marcador = L.marker(item.coord, { icon: iconeApoio })
              .bindPopup(`<strong>${item.nome}</strong><br><a href="https://www.google.com/maps/dir/?api=1&destination=${item.coord[0]},${item.coord[1]}" target="_blank">Ver rota</a>`);
            grupoApoio.addLayer(marcador);
          }
        });
      }

      grupoCameras.addTo(mapa);
      grupoApoio.addTo(mapa);
    }
  </script>
</body>
</html>
